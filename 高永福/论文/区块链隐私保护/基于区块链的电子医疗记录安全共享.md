

# 本文解决了什么问题

针对电子医疗记录 (EMR) 共享面临的数据提供商集权化、患者数据管理显被动、互操作效率低、恶意传播等问 

题，提出一种基于区块链的电子医疗记录安全共享方法



# 问题重要性

区块链隐私保护特性及其与监管科技的融合有利于加速区块链应用落地

# 前任对该问题的理解和认识

用区块链实现电子医疗记录管理与共享 ：方案[3][6]6[7]

通用架构：医生、患者、区块链

医生负责生成发布患者的电子记录到区块链

患者在区块链上检索电子医疗记录并向其他医生展示

为了节省区块链存储代价，部分方案将原始电子医疗记录存储在云端，仅将哈希值，索引时间戳等摘要信息记录到区块链



存在电子医疗记录隐私泄露问题。一方面区块链的公开透明性导致任意实体均可获取链上的电子医疗记录；

加密技术或访问控制技术可有效解决  区块链任意实体可获取链上的电子医疗记录	   问题[8][9]，

# 本文的理解和认识

本文使用区块链：PETchaibm以用户为中心的隐私增强解决方案，里用区块链智能合约，星际文件系统和可信执行环境

## 系统角色

- user
- Service provider
- 分布式存储：开源的文件分享系统
- Trusted Executor：提供TEE环境，允许在某些数据上执行代码，同时保证数据以及代码的机密性和完整性
- Blockchain：支持Dapp的点地点分布式平台



用户和云服务上都需在以太坊上注册账户，

用户同时需要注册合约账户需要部署智能合约

# 区别





# 为什么更合理



# 方法和途径（主要idea，画图，关键技术）



## 以太坊中的链中账户：外部账户和合约账户







![image-20211201185353331](C:\Users\高永福\AppData\Roaming\Typora\typora-user-images\image-20211201185353331.png)



用户和云服务上都需在以太坊上注册账户，

用户同时需要注册合约账户需要部署智能合约





![image-20211201152814465](C:\Users\高永福\AppData\Roaming\Typora\typora-user-images\image-20211201152814465.png)

PETchain上的若干个密钥

![image-20211201185623779](C:\Users\高永福\AppData\Roaming\Typora\typora-user-images\image-20211201185623779.png)



生成的账户长度为20位（即EOA公钥）

- 用户发送信息时，需要使用自己的私钥将消息进行签名
- Kd为分布式密钥，为用户将数据上传到分布式存储之前对数据进行加密
- 上传的数据由其数据标识符将其进行标识
- 用户与可信执行者共享密钥Kte
- 用户用Kte加密Kd产生Kde,然后将其与数据标识符存储在智能合约上面

PETchain上面会收到两种信息：一种是API的调用，和智能合约的交易

API信息被实体用来交互

合约交易通过以太坊发送给智能合约



## 1. Publish smartcontract

用户定义其对合约的访问，包含授权使用用户数据的提供商列表(加密的用户数据可以供谁使用)



## 2. Store data:

用户用产生的私钥加密其数据并将其传入至云端

![image-20211201192828603](C:\Users\高永福\AppData\Roaming\Typora\typora-user-images\image-20211201192828603.png)

**存在问题**  是否是Kd

## 3. Update data identifier

用户通过智能合约更新数据标识符

## 4. Request data

- 云服务商通过调用智能合'约的一个函数请求数据

- 如果云服务商在用户允许的列表当中，则返回加密的数据以及密钥Kde

- 同时收到可信任执行者的url

## 5. Send code

- 云服务商将要在用户数据和标识符上面执行的代码发送给可信执行者

## 6. Data transfer

- 可信执行者通过数据标识符在分布式系统上下载数据

## 7. Process data

- 使用服务商发送过来的代码在孤立的安全环境上处理数据

- 可信执行者解密Kde得到Kd，用Kd去解密下载的数据

## 8. Share data



![image-20211201195204770](C:\Users\高永福\AppData\Roaming\Typora\typora-user-images\image-20211201195204770.png)

TA数据处理的结果分享给服务商

## 9 Provide services

服务提供商使用这些结果向用户提供服务



 

用户在智能合约上维护授权可以使用他们数据的服务提供商（EOA地址）的列表，（但是智能合约一旦部署不就无法更改，怎么维护）

用户将加密的数据存储在分布式存储中，从而保证了数据的安全性。只有在可信执行器才能解密和处理用户数据，这是在安全隔离的环境中完成的，确保用户的隐私，这样服务商就能在不接触数据的情况下，使用数据





**分布式系统的好处**

没有单点故障，数据是分散存储的，同时对等节点可以直接共享内容，因此可以实现更开的数据访问，

使用IPFS作为其分布式数据存储系统

## InterPlanetary FILE SYSTEM

https://ipfs.io/

官网

> **文件上传时的流程**：

- 上传文件的时候，文件会分成小块，经过哈希，得到的值为标识符CID，该CID充当文件记录，存储时节点随机选取
- 请求一个文件哈希值的时候，然后根据分布式哈希标找到文件所在的节点，取回文件并验证文件数据，（不清楚是否过一段时间会清楚数据，数据冗余问题）还有，只能存储新的文件，

IPFS本质上是一种内容可寻址/版本化/点对点超媒体的分布式存储/传输协议，可以构建更快/更安全/更自由的互联网时代

所以存在激励机制，节点更长久的在线可以获得奖励



## PETchain 智能合约

通过智能合约存储数据

- data_id: 包括数据标识符
- data_key : 包括加密数据的密钥Kd
- SP_Address：包含服务提供商的地址    **？？？？**
- TE_url：包括可信执行器的URL
- Status：指明云服务商是否可信

存储键值对虚拟哈希表 

### 合约的五种方法

- set_identifier（data_id, SP_address, data_key, TE_url）: 

在创建合约的时候应该会有创建四个map类型的变量，

这种类型的变量就类似于python中的字典



首先判断上传信息的发送者是否是合约的拥有者

- set_authorication（SP_address,status）

设置可用信息的服务商列表

- get_identifier()

如果发送信息的服务商在允许列表里面，则返回给数据标识符，数据加密密钥，TE的URL

- destroy_smartcontract()

如果发送信息者是用户

则销毁智能合约

- pause_smartcontract()

暂停拥有者的智能合约

# 创新点

以太坊上无法存储大量数据，	是需要花费Gas费

因此只存储码

把码返回给云服务商，云服务商将码发送给可信执行器

可信执行器解密，将服务商要执行的代码的结果返回给服务商



## Intel SGX 

sofrware guard extensions 指令集扩展

区别以往的TEE 系统有着较大的可信计算基（TCB

# 相关数据（仿真参数和性能评价的标准）



# 本文存在的问题



# 对问题的展望，以及可以开展的工作

