# 重放攻击



# the DAO攻击





## 账户

以太坊的账户不仅可以存储余额，还能自定义存放任意其他数据，

以太坊作为智能合约操作平台，分为外部账户EOAs和合约账户contract account

### 外部账户

通过私钥创建的用户，类似ATM的号

- 有余额
- 能发送交易，转账，执行智能合约
- 被私钥控制
- 没有相关的可执行代码

## 合约账户

含有合约代码的账户

被 **外部账户**  或者 **合约创建** 合约在创建时自动分配到一个账户地址，用于存储代码或者执行过程中产生的数据

**因为合约由其他账户创建，因此将创建者地址和该交易的随机数进行哈希后截取部分生成。**

- 有余额
- 没私钥
- 合约代码能够被交易或者其他合约消息调用
- 被执行时可调用其他合约
- 可永久改变合约内部的数据存储

![以太坊账户数据结构](%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%8A%80%E6%9C%AF%E4%B8%8E%E5%AE%9E%E7%8E%B0.assets/14_%E4%BB%A5%E5%A4%AA%E5%9D%8A%E8%B4%A6%E6%88%B7%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%841.png!de)



CodeHash为空时，账户是一个外部账户，否则是合约账户

**以太坊账户数据结构**

![以太坊账户数据存储结构](%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%8A%80%E6%9C%AF%E4%B8%8E%E5%AE%9E%E7%8E%B0.assets/14_%E4%BB%A5%E5%A4%AA%E5%9D%8A%E8%B4%A6%E6%88%B7%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84.png!de)

合约代码通过哈希值关联。每个账户对象，作为一个以太坊账户树的一个叶子存储，不能太大，

以太坊世界态（World State）状态机



![以太坊世界态](%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%8A%80%E6%9C%AF%E4%B8%8E%E5%AE%9E%E7%8E%B0.assets/19_ethereum-global-state.png!de)





Nonce 避免重放攻击，触发一次账户执行则Nonce值增加一次。



账户状态StateRoot，简单来讲是二叉树的根节点值，是合约所拥有的方法，合约的变化会反应到这里







## 交易

### 交易数据结构

![以太坊交易数据结构](%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%8A%80%E6%9C%AF%E4%B8%8E%E5%AE%9E%E7%8E%B0.assets/24_transaction-struct.png!de)

 `gasPrice` 是愿意支付的燃料单价。`gasPrcie * gas` 则为愿意为这笔交易支付的最高手续费





# 第二章 挖矿核心

## 交易池

### 交易处理流程

每个账户都有一个键值对形式的持久化存储。其中 key 和 value 的长度都是256位，我们称之为 **存储** 。

每个账户有一个以太币余额（ **balance** ）（单位是“Wei”），余额会因为发送包含以太币的交易而改变。

