# 共识算法

**一致性：**指的是系统中多个副本对外呈现的状态，即数据是否一致

**共识：**分布式系统中多个节点对一个事件达成一致的过程（例如多个事务请求，先执行谁）





**非拜占庭错误：**出现不故障，但是不会伪造信息的情况，伪造信息恶意相应的情况为**拜占庭错误**



## 常见算法

共识算法分为容忍拜占庭错误**CFT** 和不容忍拜占庭错误**BFT**两类

> 非拜占庭错误

- Paxos
- Raft

> 拜占庭错误

- PBFT

- PoW

  这两种为确定性算法，达成共识后无法逆转，共识为最终结果

拜占庭类容错算法  **往往** 性能较差，容忍不超过1/3的故障节点



**一个可扩展的分布式系统的共识算法通用解法的下限----没有下限**

即FLP原理

## FLP原理

**FLP 不可能原理**：在网络可靠，但允许节点失效（即便只有一个）的最小化异步模型系统中，不存在一个可以解决一致性问题的确定性共识算法（No completely asynchronous consensus protocol can tolerate even a single unannounced process death）。

提出并证明该定理的论文《Impossibility of Distributed Consensus with One Faulty Process》是由 Fischer，Lynch 和 Patterson 三位科学家于 1985 年发表，该论文后来获得了 Dijkstra（就是发明最短路径算法的那位计算机科学家）奖。

FLP 不可能原理告诉我们，**不要浪费时间，去试图为异步分布式系统设计面向任意场景的共识算法**。

**同步：**系统中各个节点时钟误差存在上限，并且消息传递必须在一定时间内完成，否则认为失败；

各节点对消息处理的时间也是一定的

**异步：**系统中各个节点可能存在较大时间误差，消息传输时间无上限（这就导致发送方可能不清楚接收方的状态），各个节点对消息处理的时间也是任意长的







**个人理解**：由于异步模型中消息传输事件任意长度，当接收信息的节点失效时，发送方永远不会知道接收方是响应时间过长还是无法响应





理论上来讲，无法追求完美，但是付出一些代价，能够做的更好

即CAP原理  ， 付出一些代价，让共识做的更好

## CAP原理

**定义**：分布式系统无法同时确保以下三种特性



- **一致性**：副本上的状态，都是事务成功提交后的结果，并且状态均相同（强一致性）

- 可用性：系统上有效节点，能在有效时间内完成对操作请求的应答
- 分区容忍性：网络可能会发生故障，即节点直接无法正常通信，当网络故障不应该影响系统的正常运行



举例：网络发生故障，节点之间无法通行，那么存在以下情况

- 给节点发送请求，节点无法相应，牺牲可用性
- 节点响应，但是和其他节点状态不同，牺牲一致性



大多数情况下认为，网络为可用的，因此一致性和可用性上面会二选一



## 多阶段提交

- 两阶段提交：
  - 第一阶段：预提交，协调者发布提交一个事务的请求，各个参与者尝试提交，并向协调者反馈能否提交成功
  - 第二阶段：正式提交，协调者收到所有参与者的成功答复，发出正式提交的请求。

存在问题：由于参与者需要提交，因此存在无法正常提交被阻塞的问题，导致系统性能较差





- 三阶段提交：
  - 尝试预提交：和两阶段第一步大部分相同，**不同在于** 参与者无需执行提交，只需返回大幅，因此一定程度避免参与者被无效卒社的情况
  - 预提交：协调者收到全部为真的答复，发起请求，参与者尝试提交
  - 正式提交：协调者受到参与者成功答复，发起正式提交请求



## Paxs算法与Raft算法

### Paxos算法

#### 基本原理

There is only one consensus protocol, and that's Paxos

**基本概念**

- Proposal value：提案的值
- Proposal Number ： 提案编号
- Proposal：提案 = 上面两者相加



- 提议者（Proposer）：发出提案
- 决策者（Acceptor）：对每个Proposal进行投票，获得多个决策者的接收，则该提案被批准
- 学习者（Learner）：不参与决策，从上面两者学习、记录最新达成共识的提案



> 待笑消化